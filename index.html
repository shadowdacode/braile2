<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor de Braile</title>
<style>
body{background:#111;color:#eee;font-family:sans-serif;text-align:center;margin:0;padding:0}
#controls{padding:10px;background:#222;display:flex;gap:10px;align-items:center;justify-content:center}
video,canvas{max-width:100%;height:auto}
#vid,#ov{position:relative;width:640px;height:480px}
#ov{position:absolute;top:0;left:0}
</style>
</head>
<body>
<div id="controls">
<select id="cams"></select>
<button id="start" disabled>Iniciar</button>
<label><input type="checkbox" id="auto" checked>auto ROI</label>
<label><input type="checkbox" id="dbg" checked>debug</label>
<label>Limiar <input type="range" id="thr" min="30" max="220" value="110"></label>
<label><input type="checkbox" id="dark">pontos escuros</label>
</div>
<div style="position:relative;display:inline-block">
<video id="vid" muted playsinline></video>
<canvas id="ov"></canvas>
</div>
<div>Letra: <span id="ltr">?</span></div>
<script src="https://docs.opencv.org/4.10.0/opencv.js" defer></script>
<script>
// aguarda OpenCV
let cvReady=false;
let stream=null;let cap=null;let roi=null;let dragging=false;let dragOff={x:0,y:0};
let lastChar='?';
const camSel=document.getElementById('cams');
const startBtn=document.getElementById('start');
const auto=document.getElementById('auto');
const dbg=document.getElementById('dbg');
const thr=document.getElementById('thr');
const dark=document.getElementById('dark');
const vid=document.getElementById('vid');
const cvs=document.getElementById('ov');
const ctx=cvs.getContext('2d');
const ltrSpan=document.getElementById('ltr');
const speak=ch=>{speechSynthesis.cancel();speechSynthesis.speak(new SpeechSynthesisUtterance(ch));};
function listCams(){navigator.mediaDevices.enumerateDevices().then(devs=>{camSel.innerHTML='';devs.filter(d=>d.kind==='videoinput').forEach((d,i)=>{const o=document.createElement('option');o.value=d.deviceId;o.text=d.label||`camera ${i+1}`;camSel.appendChild(o);});});}
function start(){if(stream){stream.getTracks().forEach(t=>t.stop());}
const id=camSel.value;navigator.mediaDevices.getUserMedia({video:{deviceId:id?{exact:id}:undefined}}).then(s=>{stream=s;vid.srcObject=s;vid.play();cap=new cv.VideoCapture(vid);roi=null;requestAnimationFrame(loop);});}
function setROI(x,y,w,h){roi={x,y,w,h};}
function drawROI(){if(!roi)return;ctx.strokeStyle='yellow';ctx.lineWidth=2;ctx.strokeRect(roi.x*cvs.width,roi.y*cvs.height,roi.w*cvs.width,roi.h*cvs.height);}
function loop(){if(!cap){requestAnimationFrame(loop);return;}
const src=new cv.Mat(vid.videoHeight,vid.videoWidth,cv.CV_8UC4);cap.read(src);cvs.width=src.cols;cvs.height=src.rows;ctx.clearRect(0,0,cvs.width,cvs.height);
let r=roi;if(auto.checked){const gray=new cv.Mat();cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);const blr=new cv.Mat();cv.GaussianBlur(gray,blr,new cv.Size(5,5),0);const edges=new cv.Mat();cv.Canny(blr,edges,60,180);const ctrs=new cv.MatVector();const hier=new cv.Mat();cv.findContours(edges,ctrs,hier,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let maxRect=null;for(let i=0;i<ctrs.size();i++){const c=ctrs.get(i);const rect=cv.boundingRect(c);const ar=rect.height/rect.width;const area=cv.contourArea(c);if(ar>1.4&&ar<1.8&&rect.width>0.15*src.cols&&rect.width<0.6*src.cols&&area>=0.3*rect.width*rect.height){if(!maxRect||rect.width*rect.height>maxRect.width*maxRect.height){maxRect=rect;}}}
if(maxRect){r={x:maxRect.x/src.cols,y:maxRect.y/src.rows,w:maxRect.width/src.cols,h:maxRect.height/src.rows};setROI(r.x,r.y,r.w,r.h);}gray.delete();blr.delete();edges.delete();ctrs.delete();hier.delete();}
if(r){processROI(src,r);}else{ltrSpan.textContent='?';lastChar='?';}
drawROI();src.delete();requestAnimationFrame(loop);}
function processROI(src,r){const rx=Math.round(r.x*src.cols);const ry=Math.round(r.y*src.rows);const rw=Math.round(r.w*src.cols);const rh=Math.round(r.h*src.rows);const roiMat=src.roi(new cv.Rect(rx,ry,rw,rh));const cellW=rw/2;const cellH=rh/3;let bits=0;for(let i=0;i<6;i++){const cx=Math.round((i<3?0:1)*cellW+cellW/2);const cy=Math.round(((i%3)+0.5)*cellH);const radius=Math.round(0.28*Math.min(cellW,cellH));const mask=cv.Mat.zeros(roiMat.rows,roiMat.cols,cv.CV_8UC1);cv.circle(mask,new cv.Point(cx,cy),radius,new cv.Scalar(255),-1);const mean=cv.mean(roiMat,mask)[0];if(dbg.checked){ctx.beginPath();ctx.strokeStyle=mean>(thr.value)?(dark.checked?'red':'green'):(dark.checked?'green':'red');ctx.arc(rx+cx,ry+cy,radius,0,2*Math.PI);ctx.stroke();}
const on=dark.checked?mean<thr.value:mean>thr.value;if(on)bits|=1<<i;mask.delete();}
roiMat.delete();const map={1:'a',3:'b',9:'c',25:'d',17:'e',11:'f',27:'g',19:'h',10:'i',26:'j',33:'k',35:'l',41:'m',57:'n',49:'o',43:'p',59:'q',51:'r',42:'s',58:'t',97:'u',99:'v',122:'w',105:'x',121:'y',113:'z'};const ch=map[bits]||'?';ltrSpan.textContent=ch;if(ch!==lastChar&&ch!=='?'){speak(ch);lastChar=ch;}else if(ch==='?'){lastChar='?';}}
cvs.addEventListener('mousedown',e=>{if(auto.checked||!roi)return;const rect=cvs.getBoundingClientRect();const x=(e.clientX-rect.left)/cvs.width;const y=(e.clientY-rect.top)/cvs.height;if(x>roi.x&&x<roi.x+roi.w&&y>roi.y&&y<roi.y+roi.h){dragging=true;dragOff.x=x-roi.x;dragOff.y=y-roi.y;}});
cvs.addEventListener('mousemove',e=>{if(!dragging)return;const rect=cvs.getBoundingClientRect();let x=(e.clientX-rect.left)/cvs.width-dragOff.x;let y=(e.clientY-rect.top)/cvs.height-dragOff.y;x=Math.max(0,Math.min(1-roi.w,x));y=Math.max(0,Math.min(1-roi.h,y));setROI(x,y,roi.w,roi.h);});
cvs.addEventListener('mouseup',()=>{dragging=false;});
cvs.addEventListener('mouseleave',()=>{dragging=false;});
cv['onRuntimeInitialized']=()=>{cvReady=true;startBtn.disabled=false;listCams();};
startBtn.onclick=()=>{if(cvReady)start();};
</script>
</body>
</html>
